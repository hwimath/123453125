<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>í•œ ìë¦¬ ë§ì…ˆ</title>
  <style>
    /* (1) í™”ë©´ ë¶„í• : ì‹œì‘í™”ë©´, ê²Œì„í™”ë©´, ì¢…ë£Œí™”ë©´ì„ ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€ */
    #start-screen,
    #game-screen,
    #end-screen {
      display: none;       /* ê¸°ë³¸ì ìœ¼ë¡œ ë³´ì´ì§€ ì•ŠìŒ */
      padding: 20px;
      text-align: center;
      font-family: 'Arial', sans-serif;
      background-color: #fff8dc;
      margin: 0 auto;
    }

    /* .visible í´ë˜ìŠ¤ë¥¼ ê°€ì§„ í™”ë©´ë§Œ ë³´ì´ë„ë¡ ì„¤ì • */
    #start-screen.visible,
    #game-screen.visible,
    #end-screen.visible {
      display: block;
    }

    h1 {
      color: #ff4500;
      margin-bottom: 10px;
    }
    h2 {
      color: #333;
      margin-bottom: 20px;
    }
    .button {
      padding: 15px 25px;
      font-size: 20px;
      margin: 10px;
      cursor: pointer;
      border: none;
      border-radius: 10px;
      background-color: #ffa07a;
      color: white;
      transition: background-color 0.3s;
    }
    .button:hover {
      background-color: #ff7f50;
    }
    #energy-bar {
      width: 100%;
      height: 30px;
      background-color: #eee;
      margin: 20px 0;
      border-radius: 15px;
      overflow: hidden;
    }
    #energy {
      height: 100%;
      background-color: #32cd32;
      width: 100%;
      transition: width 0.2s linear;
    }
    #stats {
      margin-top: 20px;
      font-size: 20px;
    }
    #message {
      font-size: 24px;
      color: #dc143c;
      margin-top: 20px;
      min-height: 30px;
    }
    .question-container {
      margin: 20px 0;
      text-align: center;
    }
    .question {
      font-size: 32px;
      margin-bottom: 20px;
    }
    #answer-input {
      padding: 10px;
      font-size: 24px;
      width: 100px;
      text-align: center;
      border: 2px solid #20b2aa;
      border-radius: 10px;
    }
    #submit-answer {
      padding: 10px 20px;
      font-size: 20px;
      margin-left: 10px;
      cursor: pointer;
      border: none;
      border-radius: 10px;
      background-color: #20b2aa;
      color: white;
      transition: background-color 0.3s;
    }
    #submit-answer:hover {
      background-color: #3cb371;
    }
    #next-button {
      padding: 10px 20px;
      font-size: 20px;
      cursor: pointer;
      border: none;
      border-radius: 10px;
      background-color: #32cd32;
      color: white;
      transition: background-color 0.3s;
      display: none; /* ì´ˆê¸°ì— ë³´ì´ì§€ ì•Šë„ë¡ ì„¤ì • */
      margin-top: 20px;
    }
    #next-button:hover {
      background-color: #3cb371;
    }
    #results {
      margin-top: 20px;
      text-align: center;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
      overflow-y: scroll;
      max-height: 400px;
    }
    .result-item {
      margin-bottom: 10px;
      font-size: 20px;
    }
    #response {
      margin-top: 20px;
      white-space: pre-wrap; /* JSON ì‘ë‹µ í¬ë§·ì„ ë³´ê¸° ì¢‹ê²Œ í‘œì‹œ */
      font-size: 16px;
      color: #000;
    }
  </style>
</head>
<body>

  <!-- (A) ì‹œì‘ í™”ë©´ -->
  <div id="start-screen" class="visible">
    <h1>í•œ ìë¦¬ ë§ì…ˆ</h1>
    <div>
      <label for="player-name">ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:</label><br />
      <input type="text" id="player-name" style="padding: 10px; font-size: 16px;" />
    </div>
    <h2>ë‚œì´ë„ë¥¼ ì„ íƒí•˜ì„¸ìš”</h2>
    <button class="button" onclick="startGame('highest')">ìµœìƒ</button>
    <button class="button" onclick="startGame('high')">ìƒ</button>
    <button class="button" onclick="startGame('medium')">ì¤‘</button>
    <button class="button" onclick="startGame('low')">í•˜</button>
  </div>

  <!-- (B) ê²Œì„ í™”ë©´ -->
  <div id="game-screen">
    <h1>í•œ ìë¦¬ ë§ì…ˆ</h1>

    <!-- ì—ë„ˆì§€ë°”(íƒ€ì´ë¨¸) -->
    <div id="energy-bar">
      <div id="energy"></div>
    </div>

    <!-- ë¬¸ì œ/ì •ë‹µ ì˜ì—­ -->
    <div id="question-container"></div>
    <div id="message"></div>

    <button id="submit-answer" onclick="checkAnswer()">ì œì¶œ</button>
    <button id="next-button" onclick="nextQuestion()">ë‹¤ìŒ ë¬¸ì œ</button>

    <!-- ì ìˆ˜/ìƒëª…/ì‹œê°„ í‘œì‹œ -->
    <div id="stats">
      <p>ì ìˆ˜: <span id="score">0</span></p>
      <p>ë‚¨ì€ ìƒëª…: <span id="lives">3</span></p>
      <p>ì´ ê²Œì„ ì‹œê°„: <span id="game-time">0</span>ì´ˆ</p>
    </div>
  </div>

  <!-- (C) ì¢…ë£Œ í™”ë©´ -->
  <div id="end-screen">
    <h1>ê²Œì„ ì¢…ë£Œ!</h1>
    <p>ìµœì¢… ì ìˆ˜: <span id="final-score">0</span></p>
    <p>ì´ ê²Œì„ ì‹œê°„: <span id="final-time">0</span>ì´ˆ</p>

    <div id="results">
      <h2>ì •ë‹µ í™•ì¸</h2>
      <!-- ì •ë‹µ ëª©ë¡ì´ í‘œì‹œë  ê³µê°„ -->
    </div>

    <button class="button" onclick="restartGame()">ë‹¤ì‹œ ì‹œì‘</button>
    <!-- ì ìˆ˜ ì „ì†¡ ë²„íŠ¼ -->
    <button class="button" onclick="sendScore()">ì ìˆ˜ì „ì†¡</button>
    <div id="response"></div>
  </div>

  <script>
    /* -----------------------------
       ì „ì—­ ë³€ìˆ˜ ë° ì„¤ì •
    ------------------------------*/
    let difficulty;         // ë‚œì´ë„
    let timeLimit;          // ì œí•œ ì‹œê°„
    let score = 0;          // ì ìˆ˜
    let lives = 3;          // ìƒëª…
    let totalGameTime = 0;  // ì´ ê²Œì„ ì‹œê°„
    let gameInterval;       // ê²Œì„ ì‹œê°„ ì¸¡ì • interval
    let energyInterval;     // ì—ë„ˆì§€ë°”(íƒ€ì´ë¨¸) interval
    let gameStartTime;      // ê²Œì„ ì‹œì‘ ì‹œê° (ms)
    let currentQuestionIndex = 0; // í˜„ì¬ ë¬¸ì œ ì¸ë±ìŠ¤
    let shuffledQuestions = [];   // ì„ì€ ë¬¸ì œ ë°°ì—´
    let playerName = "";    // ì‚¬ìš©ì ì´ë¦„

    // ë‚œì´ë„ë³„ ì‹œê°„/ì ìˆ˜ ì„¤ì •(ì´ë²ˆì—ëŠ” ì ìˆ˜ëŠ” ì“°ì§€ ì•Šì§€ë§Œ, ì‹œê°„ ì œí•œìš©ìœ¼ë¡œ ìœ ì§€)
    const difficultySettings = {
      'highest': { time: 20, points: 20 },
      'high':    { time: 30, points: 15 },
      'medium':  { time: 40, points: 10 },
      'low':     { time: null, points: 5 } // í•˜ ë‚œì´ë„ëŠ” ì‹œê°„ ì œí•œ ì—†ìŒ
    };

    /* -----------------------------
       (1) ë¬¸ì œ ìƒì„± (ì›ë³¸ 0~9ê¹Œì§€ ë§ì…ˆ ì ˆëŒ€ ìƒëµ ê¸ˆì§€)
    ------------------------------*/
    function generateProblems() {
      const problems = [];
      for (let a = 0; a <= 9; a++) {
        for (let b = 0; b <= 9; b++) {
          problems.push({ a: a, b: b });
        }
      }
      return problems;
    }

    /* -----------------------------
       (2) ë¬¸ì œ ë°°ì—´ ì„ê¸°
    ------------------------------*/
    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        let j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    /* -----------------------------
       (3) ê²Œì„ ì‹œì‘: ë‚œì´ë„ ì„ íƒ -> í™”ë©´ ì „í™˜ -> ì´ˆê¸°í™”
    ------------------------------*/
    window.startGame = function(selectedDifficulty) {
      // ì‚¬ìš©ì ì´ë¦„ ì…ë ¥
      const inputName = document.getElementById('player-name').value.trim();
      playerName = inputName ? inputName : "ì´ë¦„ì—†ìŒ";

      difficulty = selectedDifficulty;
      timeLimit = difficultySettings[difficulty].time;

      // (A) ìŠ¤íƒ€íŠ¸ í™”ë©´ -> ìˆ¨ê¹€
      document.getElementById('start-screen').classList.remove('visible');
      // (B) ê²Œì„ í™”ë©´ -> í‘œì‹œ
      document.getElementById('game-screen').classList.add('visible');

      // ë³€ìˆ˜ ì´ˆê¸°í™”
      score = 0;
      lives = 3;
      totalGameTime = 0;
      currentQuestionIndex = 0;
      shuffledQuestions = shuffleArray(generateProblems());
      updateStats();

      // ì²« ë¬¸ì œ ë Œë”ë§
      renderQuestion();

      // ì‹œê°„ ì œí•œì´ ìˆëŠ” ë‚œì´ë„ë¼ë©´ ì—ë„ˆì§€ë°” í‘œì‹œ ë° ì‹œì‘
      const energyBar = document.getElementById('energy-bar');
      if (timeLimit !== null) {
        energyBar.style.display = 'block';
        startEnergyBar();
      } else {
        // ì‹œê°„ ì œí•œ ì—†ìœ¼ë©´ ì—ë„ˆì§€ë°” ìˆ¨ê¸°ê¸°
        energyBar.style.display = 'none';
      }

      // ê²Œì„ ì‹œê°„ ì¸¡ì • ì‹œì‘
      gameStartTime = Date.now();
      gameInterval = setInterval(() => {
        totalGameTime = Math.floor((Date.now() - gameStartTime) / 1000);
        document.getElementById('game-time').innerText = totalGameTime;
      }, 1000);
    };

    /* -----------------------------
       (4) ë¬¸ì œ í™”ë©´ êµ¬ì„±
    ------------------------------*/
    function renderQuestion() {
      if (currentQuestionIndex >= shuffledQuestions.length) {
        endGame();
        return;
      }
      const container = document.getElementById('question-container');
      container.innerHTML = '';

      const currentProblem = shuffledQuestions[currentQuestionIndex];
      const div = document.createElement('div');
      div.className = 'question-container';
      div.innerHTML = `
        <div class="question">${currentProblem.a} + ${currentProblem.b} = ?</div>
        <input type="number" id="answer-input" placeholder="ë‹µì„ ì…ë ¥í•˜ì„¸ìš”" />
      `;
      container.appendChild(div);

      document.getElementById('message').innerHTML = '';
    }

    /* -----------------------------
       (5) ì •ë‹µ ì œì¶œ ì²´í¬ (ì—¬ê¸°ì„œ +10ì )
    ------------------------------*/
    window.checkAnswer = function() {
      const currentProblem = shuffledQuestions[currentQuestionIndex];
      const userInput = document.getElementById('answer-input').value.trim();
      const correctAnswer = currentProblem.a + currentProblem.b;

      // ì…ë ¥ê°’ì´ ê³µë°±ì´ë©´ ë©”ì‹œì§€ í‘œì‹œ
      if (userInput === '') {
        document.getElementById('message').innerHTML = 'ë‹µì„ ì…ë ¥í•´ì£¼ì„¸ìš”!';
        return;
      }

      // ì •ë‹µ ì—¬ë¶€ íŒë³„
      if (Number(userInput) === correctAnswer) {
        // ìˆ˜ì • í¬ì¸íŠ¸: ë¬´ì¡°ê±´ 10ì ì”© ì˜¬ë ¤ì¤Œ
        score += 10;
        document.getElementById('message').innerHTML = 'ì •ë‹µì…ë‹ˆë‹¤! ğŸ‰';
      } else {
        lives -= 1;
        document.getElementById('message').innerHTML =
          `í‹€ë ¸ìŠµë‹ˆë‹¤! ì •ë‹µì€ <strong>${correctAnswer}</strong>ì…ë‹ˆë‹¤. ğŸ˜¢`;
      }

      updateStats();
      disableInput();
      // ë§ê±°ë‚˜ í‹€ë ¤ì•¼ ë‹¤ìŒ ë¬¸ì œ ë²„íŠ¼ì´ í™œì„±í™”
      document.getElementById('next-button').style.display = 'inline-block';

      // ìƒëª…ì´ 0 ì´í•˜ì´ë©´ ë°”ë¡œ ê²Œì„ ì¢…ë£Œ
      if (lives <= 0) {
        endGame();
      }
    };

    // ì…ë ¥ í•„ë“œì™€ ì œì¶œ ë²„íŠ¼ì„ ë¹„í™œì„±í™”
    function disableInput() {
      document.getElementById('answer-input').disabled = true;
      document.getElementById('submit-answer').disabled = true;
    }

    /* -----------------------------
       (6) ë‹¤ìŒ ë¬¸ì œ ë²„íŠ¼
    ------------------------------*/
    window.nextQuestion = function() {
      currentQuestionIndex++;
      renderQuestion();
      document.getElementById('next-button').style.display = 'none';
      document.getElementById('answer-input').disabled = false;
      document.getElementById('submit-answer').disabled = false;
      document.getElementById('answer-input').value = '';
      document.getElementById('answer-input').style.borderColor = '#20b2aa';

      // ë‹¤ìŒ ë¬¸ì œ ì‹œì‘ ì‹œ ë‹¤ì‹œ ì—ë„ˆì§€ë°” ë¦¬ì…‹
      if (timeLimit !== null) {
        startEnergyBar();
      }
    };

    /* -----------------------------
       (7) ì ìˆ˜/ìƒëª…/ê²Œì„ ì‹œê°„ í‘œì‹œ
    ------------------------------*/
    function updateStats() {
      document.getElementById('score').innerText = score;
      document.getElementById('lives').innerText = lives;
      document.getElementById('game-time').innerText = totalGameTime;
    }

    /* -----------------------------
       (8) ì—ë„ˆì§€ ë°” (íƒ€ì´ë¨¸) ì‹œì‘
    ------------------------------*/
    function startEnergyBar() {
      clearInterval(energyInterval);
      const energyBar = document.getElementById('energy');
      let width = 100;
      // timeLimitì´ˆ ë™ì•ˆ 100% -> 0%ë¡œ ì¤„ê¸°. 0.1ì´ˆë§ˆë‹¤ ê°ì†Œ
      const decrement = 100 / (timeLimit * 10);

      energyBar.style.width = '100%';
      energyInterval = setInterval(() => {
        width -= decrement;
        if (width <= 0) {
          clearInterval(energyInterval);
          // ì‹œê°„ ì´ˆê³¼ ì‹œ ìƒëª… ì°¨ê°
          lives -= 1;
          const currentProblem = shuffledQuestions[currentQuestionIndex];
          const correctAnswer = currentProblem.a + currentProblem.b;
          document.getElementById('message').innerHTML =
            `ì‹œê°„ ì´ˆê³¼! ì •ë‹µì€ <strong>${correctAnswer}</strong>ì…ë‹ˆë‹¤. ğŸ˜®`;

          updateStats();
          disableInput();
          document.getElementById('next-button').style.display = 'inline-block';

          if (lives <= 0) {
            endGame();
          }
        } else {
          energyBar.style.width = width + '%';
        }
      }, 100); // 0.1ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸
    }

    /* -----------------------------
       (9) ê²Œì„ ì¢…ë£Œ
    ------------------------------*/
    function endGame() {
      clearInterval(gameInterval);
      clearInterval(energyInterval);

      // ê²Œì„ í™”ë©´ ìˆ¨ê¸°ê³  ì¢…ë£Œ í™”ë©´ ë³´ì´ê¸°
      document.getElementById('game-screen').classList.remove('visible');
      document.getElementById('end-screen').classList.add('visible');

      document.getElementById('final-score').innerText = score;
      document.getElementById('final-time').innerText = totalGameTime;

      // ë¬¸ì œ/ì •ë‹µ ëª©ë¡ í‘œì‹œ
      const resultsContainer = document.getElementById('results');
      resultsContainer.innerHTML = '<h2>ì •ë‹µ í™•ì¸</h2>';
      shuffledQuestions
        .slice(0, currentQuestionIndex + 1)
        .forEach((q) => {
          const answer = q.a + q.b;
          resultsContainer.innerHTML +=
            `<div class="result-item">${q.a} + ${q.b} = ${answer}</div>`;
        });
    }

    /* -----------------------------
       (10) ê²Œì„ ì¬ì‹œì‘
    ------------------------------*/
    window.restartGame = function() {
      // ì¢…ë£Œ í™”ë©´ ìˆ¨ê¸°ê³ , ê²Œì„ í™”ë©´ ë³´ì´ê¸°
      document.getElementById('end-screen').classList.remove('visible');
      document.getElementById('game-screen').classList.add('visible');

      // ì´ˆê¸°í™”
      score = 0;
      lives = 3;
      totalGameTime = 0;
      currentQuestionIndex = 0;
      shuffledQuestions = shuffleArray(generateProblems());
      updateStats();
      renderQuestion();

      // ì—ë„ˆì§€ë°”(íƒ€ì´ë¨¸) ì²˜ë¦¬
      const energyBar = document.getElementById('energy-bar');
      if (timeLimit !== null) {
        energyBar.style.display = 'block';
        startEnergyBar();
      } else {
        energyBar.style.display = 'none';
      }

      // ì‹œê°„ ë‹¤ì‹œ ì¸¡ì •
      gameStartTime = Date.now();
      gameInterval = setInterval(() => {
        totalGameTime = Math.floor((Date.now() - gameStartTime) / 1000);
        document.getElementById('game-time').innerText = totalGameTime;
      }, 1000);
    };

    /* -----------------------------
       (11) ì ìˆ˜ ì „ì†¡(ë¬¸ì œì—ì„œ ì£¼ì–´ì§„ í•¨ìˆ˜)
    ------------------------------*/
    async function saveData(game, name, score, elapsedTime) {
      const FUNCTION_URL = "https://us-central1-record-f420d.cloudfunctions.net/report";

      const requestData = {
        game,
        name,
        score: parseInt(score, 10),
        elapsedTime: parseInt(elapsedTime, 10)
      };

      try {
        const response = await fetch(FUNCTION_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestData)
        });

        const responseData = await response.json();

        if (response.ok) {
          document.getElementById('response').innerText =
            `ì„±ê³µ: ${JSON.stringify(responseData, null, 2)}`;
        } else {
          document.getElementById('response').innerText =
            `ì˜¤ë¥˜: ${JSON.stringify(responseData, null, 2)}`;
        }
      } catch (error) {
        console.error('ìš”ì²­ ì‹¤íŒ¨:', error);
        document.getElementById('response').innerText =
          `ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`;
      }
    }

    // "ì ìˆ˜ì „ì†¡" ë²„íŠ¼ í´ë¦­ ì‹œ í˜¸ì¶œ
    window.sendScore = function() {
      saveData("í•œ ìë¦¬ ë§ì…ˆ", playerName, score, totalGameTime);
    };
  </script>

</body>
</html>
